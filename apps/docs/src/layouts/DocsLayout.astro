---
import { Image } from 'astro:assets'
import type { CollectionEntry } from 'astro:content'
import AppLayout from './AppLayout.astro'
import Logo from '$assets/logo/threlte-logo.png'
import LogoOnly from '$assets/logo/threlte-logo-only.png'
import LeftSidebar from '$components/Menu/LeftSidebar/LeftSidebar.astro'
import Socials from '$components/Socials/Socials.astro'
import RightSidebar from '$components/Menu/RightSidebar/RightSidebar.astro'
import MobileDocsNav from '$components/Menu/MobileDocsNav.svelte'
import { getLeftSidebarMenu } from '$components/Menu/LeftSidebar/getLeftSidebarMenu'
import Package from './Package.astro'
import { c } from '../lib/classes'
import Book from './Book.astro'
import Circles from './Circles.astro'
import Search from '$components/Search/Search.svelte'
import Footer from '../components/Footer/Footer.astro'
import Markprompt from '$components/Search/Markprompt'

export interface Props {
  title?: string
  entry: CollectionEntry<'learn'> | CollectionEntry<'reference'>
}

const title = Astro.props.title

const sidebarMenu = await getLeftSidebarMenu()

const activeSidebarTab: 'learn' | 'reference' = Astro.url.pathname.startsWith('/docs/learn')
  ? 'learn'
  : 'reference'

const activeUrlPathName = Astro.url.pathname

const linkStyles = 'flex items-center gap-1 rounded-md text-faded hover:text-white'
const activeLinkStyles = '!text-orange'
---

<AppLayout title={title}>
  <Markprompt client:only="preact" />
  <header
    class="border-b-orange/25 fixed z-40 mx-auto hidden h-[70px] w-full flex-row items-center justify-between border-b bg-[#0A0F19] px-6 md:flex"
    transition:name="desktop_nav"
  >
    <div class="justify flex items-center justify-start gap-6 lg:gap-12">
      <a href="/">
        <Image
          src={Logo}
          alt="threlte logo"
          width={200}
          class="h-[37px] w-auto md:hidden lg:block object-contain"
          loading="eager"
        />
        <Image
          src={LogoOnly}
          alt="threlte logo"
          width={200}
          class="h-[37px] w-[37px] hidden md:block lg:hidden object-contain"
          loading="lazy"
        />
      </a>

      <div class="flex h-[30px] flex-row items-center justify-start gap-4 lg:gap-6">
        <a
          href="/docs/learn/getting-started/introduction"
          class={c(linkStyles, activeUrlPathName.includes('/docs/learn') && activeLinkStyles)}
        >
          <Book class="h-[16px] hidden lg:block" />Learn
        </a>

        <a
          href="/docs/examples/intro"
          class={c(linkStyles, activeUrlPathName.includes('/docs/examples') && activeLinkStyles)}
        >
          <Circles class="h-[16px] hidden lg:block" />Examples
        </a>

        <div class="h-full w-px bg-gray-500/70"></div>

        <div class="relative flex items-center gap-6">
          <a
            href="/docs/reference/core/getting-started"
            class={c(
              linkStyles,
              activeUrlPathName.includes('/docs/reference/core') && activeLinkStyles
            )}
          >
            <Package class="h-[16px] hidden md:block" />core</a
          >
          <a
            href="/docs/reference/extras/getting-started"
            class={c(
              linkStyles,
              activeUrlPathName.includes('/docs/reference/extras') && activeLinkStyles
            )}
          >
            <Package class="h-[16px] hidden md:block" />extras</a
          >
          <a
            href="/docs/reference/gltf/getting-started"
            class={c(
              linkStyles,
              activeUrlPathName.includes('/docs/reference/gltf') && activeLinkStyles
            )}
          >
            <Package class="h-[16px] hidden md:block" />gltf</a
          >
          <a
            href="/docs/reference/rapier/getting-started"
            class={c(
              linkStyles,
              activeUrlPathName.includes('/docs/reference/rapier') && activeLinkStyles
            )}
          >
            <Package class="h-[16px] hidden md:block" />rapier</a
          >
          <a
            href="/docs/reference/theatre/getting-started"
            class={c(
              linkStyles,
              activeUrlPathName.includes('/docs/reference/theatre') && activeLinkStyles
            )}
          >
            <Package class="h-[16px] hidden md:block" />theatre</a
          >
        </div>
      </div>
    </div>
    <div class="hidden max-w-[500px] flex-1 gap-5 lg:flex">
      <Search client:media="(min-width: 1024px)" />
      <Socials
        github
        discord
        small
      />
    </div>
  </header>

  <MobileDocsNav
    client:media="(max-width: 768px)"
    sidebarMenu={sidebarMenu}
    activeSidebarTab={activeSidebarTab}
    activeUrlPathName={activeUrlPathName}
  >
    <Image
      slot="logo"
      src={Logo}
      alt="threlte logo"
      width={200}
      class="h-[37px] w-auto"
    />

    <Socials slot="after-navigation" />
  </MobileDocsNav>

  <main
    class="grid md:grid-cols-[var(--left-sidebar-width)_1fr] lg:grid-cols-[var(--left-sidebar-width)_1fr_var(--right-sidebar-width)]"
  >
    <aside
      class="fixed bottom-0 z-10 row-span-2 hidden h-[calc(100vh-70px)] w-full place-self-start justify-self-stretch overflow-hidden md:sticky md:top-[70px] md:block md:w-auto md:pt-6 lg:row-span-1"
      transition:name="left_sidebar"
    >
      <div class="mb-6 flex flex-1 lg:hidden">
        <Search client:media="(min-width: 1024px)" />
        <!-- <Socials /> -->
      </div>
      <LeftSidebar />
    </aside>

    <div
      class="w-full justify-self-center overflow-hidden overflow-x-auto px-6 pb-12 pt-6 md:overflow-x-visible"
    >
      <article
        class="prose prose-a:text-orange before:prose-code:content-none after:prose-code:content-none prose-invert [&_p]:text-faded [&_li]:text-faded prose-a:decoration-dotted mx-auto max-w-5xl"
      >
        <slot />
      </article>
    </div>

    <aside
      class="fixed bottom-0 z-10 row-span-2 hidden h-[calc(100vh-var(--docs-navbar-height))] w-full place-self-start justify-self-stretch overflow-hidden lg:sticky lg:top-[var(--docs-navbar-height)] lg:block lg:w-auto"
      transition:name="right_sidebar"
    >
      <RightSidebar entry={Astro.props.entry} />
    </aside>
  </main>

  <Footer class="w-full px-6 mx-auto py-12 border-t border-white/20" />
</AppLayout>
