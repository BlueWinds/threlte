---
{
  order: 5,
  category: '@threlte/extras',
  name: <CSM>,
  sourcePath: 'packages/extras/src/lib/components/CSM/CSM.svelte',
  type: 'component',
  'componentSignature':
    {
      'props':
        [
          { name: 'enabled', type: 'boolean', required: false },
          { name: 'camera', type: 'THREE.Camera | undefined', required: false },
          { name: 'configure', type: '(csm: CSM) => CSM', required: false },
          { name: 'params', type: 'CSMParameters', required: false }
        ]
    }
}
---

The `<CSM/>` component offers a streamlined convenience integration of the Cascaded Shadow Maps technique, sourced from the Three.js addon.

<Example path="extras/csm" />

Cascaded Shadow Maps (CSM) are a technique employed to render shadows with varying levels of
detail based on their distance from the camera. CSMs utilize multiple shadow maps to produce
higher resolution shadows closer to the camera and gradually decrease this resolution for
shadows farther away. This method is especially beneficial when rendering sun-cast
shadows over vast terrains, ensuring detailed and performance-optimized shadow renderings.

## Usage

<Tip type="warning">Setting `castShadow` property on any lights in a scene with `<CSM>` enabled leads to crashes.</Tip>

```svelte
<script lang="ts">
  import { useThrelte } from '@threlte/core'
  import { CSM } from '@threlte/extras'
  import { PCFSoftShadowMap, Vector3 } from 'three'

  const { renderer } = useThrelte()

  let params = {
    lightDirection: new Vector3()
  }

  renderer.shadowMap.enabled = true
  renderer.shadowMap.type = PCFSoftShadowMap
</script>

<CSM
  enabled
  {params}
  configure={(csm) => {
    // advanced CSM configuration can be handle here. configure has to return csm
    return csm
  }}
>
  <!-- Your scene goes here -->
</CSM>
```

## Updating light direction

## Custom configuration

## Parameters

The `<CSM>` component exposes an optional `params` prop. Below is a comprehensive
table detailing each parameter. Please note that these parameters are only invoked when `<CSM>` is enabled.

| Name                 | Type                                                                                   | Description                                                                                                                                                                                                                                                                                                                                                                                                      |
| -------------------- | -------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| camera               | `THREE.Camera`                                                                         | Camera which is currently used for rendering.                                                                                                                                                                                                                                                                                                                                                                    |
| parent               | `THREE.Object3D`                                                                       | `THREE.Object3D` where lights will be stored                                                                                                                                                                                                                                                                                                                                                                     |
| cascades             | number                                                                                 | Number of shadow cascades.                                                                                                                                                                                                                                                                                                                                                                                       |
| maxFar               | number                                                                                 | Frustum far plane distance (i.e. shadows are not visible farther this distance from camera). May be smaller than `camera.far value.`                                                                                                                                                                                                                                                                             |
| mode                 | `"uniform" \| "logarithmic" \| "practical" \| "custom"`                                | Defines a split scheme (how large frustum is splitted into smaller ones). Can be uniform (linear), logarithmic, practical or custom. For most cases practical may be the best choice. Equations used for each scheme can be found in [GPU Gems 3. Chapter 10.](https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch10.html) If mode is set to custom, you'll need to define your own `customSplitsCallback` |
| shadowMapSize        | number                                                                                 | Resolution of shadow maps (one per cascade)                                                                                                                                                                                                                                                                                                                                                                      |
| shadowBias           | number                                                                                 | Serves the same purpose as `THREE.LightShadow.bias`, but most likely you will need to use much smaller values.                                                                                                                                                                                                                                                                                                   |
| lightDirection       | `THREE.Vector3`                                                                        | Normalized `THREE.Vector3`                                                                                                                                                                                                                                                                                                                                                                                       |
| lightIntensity       | number                                                                                 | Same as `THREE.DirectionalLight.intensity`.                                                                                                                                                                                                                                                                                                                                                                      |
| lightNear            | number                                                                                 | Shadow camera frustum near plane                                                                                                                                                                                                                                                                                                                                                                                 |
| lightFar             | number                                                                                 | Shadow camera frustum far plane                                                                                                                                                                                                                                                                                                                                                                                  |
| lightMargin          | number                                                                                 | Defines how far shadow camera is moved along z axis in cascade frustum space. The larger is the value the more space `LightShadow` will be able to cover. Should be set to high values for scenes with huge objects.                                                                                                                                                                                             |
| customSplitsCallback | `(cascades: number, cameraNear: number, cameraFar: number, breaks: number[]) => void;` | A callback to compute custom cascade splits when mode is set to `"custom"`. Callback should accept three number parameters: `cascadeCount`, `nearDistance`, `farDistance` and return an array of split distances ranging from 0 to 1, where 0 is equal to `nearDistance` and 1 is equal to `farDistance`.                                                                                                        |

For the original implementation, refer to [this github repository](https://github.com/StrandedKitty/three-csm).
